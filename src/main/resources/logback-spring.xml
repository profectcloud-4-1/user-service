<?xml version="1.0" encoding="UTF-8"?>
<configuration scan="true">

    <!-- 애플리케이션 종료 시 버퍼 로그 flush 보장 -->
    <shutdownHook class="ch.qos.logback.core.hook.DefaultShutdownHook"/>

    <property name="LOG_DIR"   value="logs"/>
    <property name="LOG_FILE"  value="application.log"/>
    <property name="MAX_SIZE"  value="10MB"/>
    <property name="MAX_DAYS"  value="30"/>
    <property name="TOTAL_CAP" value="5GB"/>

    <!-- 콘솔(개발용) -->
    <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
            <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} %-5level [%thread] %logger{36} - %msg%n</pattern>
        </encoder>
    </appender>

    <!-- 파일 롤링(날짜+용량 기준) 보관은 압축-->
    <appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${LOG_DIR}/${LOG_FILE}</file>
        <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
            <fileNamePattern>${LOG_DIR}/%d{yyyy-MM-dd}/application.%i.log.gz</fileNamePattern>
            <maxFileSize>${MAX_SIZE}</maxFileSize>
            <maxHistory>${MAX_DAYS}</maxHistory>
            <totalSizeCap>${TOTAL_CAP}</totalSizeCap>
        </rollingPolicy>
        <encoder>
            <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} %-5level [%thread] %logger{36} - %msg%n</pattern>
        </encoder>
    </appender>

    <!-- 비동기 래핑 -->
    <appender name="ASYNC_FILE" class="ch.qos.logback.classic.AsyncAppender">
        <appender-ref ref="FILE"/>
        <queueSize>8192</queueSize>
        <discardingThreshold>0</discardingThreshold>
    </appender>

    <!-- dev: 콘솔 -->
    <springProfile name="dev">
        <logger name="org.springframework" level="INFO"/>
        <logger name="profect.group1.goormdotcom" level="DEBUG"/>
        <root level="INFO">
            <appender-ref ref="CONSOLE"/>
        </root>
    </springProfile>

    <!-- prod: 콘솔 + 파일 롤링 -->
    <springProfile name="prod">
        <logger name="org.springframework" level="WARN"/>
        <logger name="profect.group1.goormdotcom" level="INFO"/>
        <root level="WARN">
            <appender-ref ref="CONSOLE"/>
            <appender-ref ref="ASYNC_FILE"/>
        </root>
    </springProfile>

</configuration>